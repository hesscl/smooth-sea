
census <- census[match(kc_shp@data$GISJOIN, census$GISJOIN),]

census <- census %>%
  filter(STATEA == "53", COUNTYA == "033") %>%
  mutate(idtract1 = idtract,
         nHU = AF7PE001,
         pOwnoccHU = AF7PE002/AF7PE001,
         medHUVal = AF9LE001)

### Training periods

#studios
Q2_2017_0B <- tract %>%
  filter(listingQtr == "2017 Q2") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q2",
         Qtr = "Q2",
         medRent = med0B,
         actualRent = medRent,
         beds = "Studio")

Q3_2017_0B <- tract %>%
  filter(listingQtr == "2017 Q3") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q3",
         Qtr = "Q3",
         medRent = med0B,
         actualRent = medRent,
         beds = "Studio")

Q4_2017_0B <- tract %>%
  filter(listingQtr == "2017 Q4") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q4",
         Qtr = "Q4",
         medRent = med0B,
         actualRent = medRent,
         beds = "Studio")

Q1_2018_0B <- tract %>%
  filter(listingQtr == "2018 Q1") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2018 Q1",
         Qtr = "Q1",
         medRent = med0B,
         actualRent = medRent,
         beds = "Studio")

#1 bedrooms
Q2_2017_1B <- tract %>%
  filter(listingQtr == "2017 Q2") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q2",
         Qtr = "Q2",
         medRent = med1B,
         actualRent = medRent,
         beds = "1 Bedroom")

Q3_2017_1B <- tract %>%
  filter(listingQtr == "2017 Q3") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q3",
         Qtr = "Q3",
         medRent = med1B,
         actualRent = medRent,
         beds = "1 Bedroom")

Q4_2017_1B <- tract %>%
  filter(listingQtr == "2017 Q4") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q4",
         Qtr = "Q4",
         medRent = med1B,
         actualRent = medRent,
         beds = "1 Bedroom")

Q1_2018_1B <- tract %>%
  filter(listingQtr == "2018 Q1") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2018 Q1",
         Qtr = "Q1",
         medRent = med1B,
         actualRent = medRent,
         beds = "1 Bedroom")

#2 bedrooms
Q2_2017_2B <- tract %>%
  filter(listingQtr == "2017 Q2") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q2",
         Qtr = "Q2",
         medRent = med2B,
         actualRent = medRent,
         beds = "2 Bedroom")

Q3_2017_2B <- tract %>%
  filter(listingQtr == "2017 Q3") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q3",
         Qtr = "Q3",
         medRent = med2B,
         actualRent = medRent,
         beds = "2 Bedroom")

Q4_2017_2B <- tract %>%
  filter(listingQtr == "2017 Q4") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q4",
         Qtr = "Q4",
         medRent = med2B,
         actualRent = medRent,
         beds = "2 Bedroom")

Q1_2018_2B <- tract %>%
  filter(listingQtr == "2018 Q1") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2018 Q1",
         Qtr = "Q4",
         medRent = med2B,
         actualRent = medRent,
         beds = "2 Bedroom")

#3 bedrooms
Q2_2017_3B <- tract %>%
  filter(listingQtr == "2017 Q2") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q2",
         Qtr = "Q2",
         medRent = med3B,
         actualRent = medRent,
         beds = "3 Bedroom")

Q3_2017_3B <- tract %>%
  filter(listingQtr == "2017 Q3") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q3",
         Qtr = "Q3",
         medRent = med3B,
         actualRent = medRent,
         beds = "3 Bedroom")

Q4_2017_3B <- tract %>%
  filter(listingQtr == "2017 Q4") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2017 Q4",
         Qtr = "Q4",
         medRent = med3B,
         actualRent = medRent,
         beds = "3 Bedroom")

Q1_2018_3B <- tract %>%
  filter(listingQtr == "2018 Q1") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2018 Q1",
         Qtr = "Q1",
         medRent = med3B,
         actualRent = medRent,
         beds = "3 Bedroom")

### Forecast/test period

#studio
Q2_2018_0B <- tract %>%
  filter(listingQtr == "2018 Q2") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2018 Q2",
         Qtr = "Q2",
         medRent = NA,
         actualRent = med0B,
         beds = "Studio")

#1 bedroom
Q2_2018_1B <- tract %>%
  filter(listingQtr == "2018 Q2") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2018 Q2",
         Qtr = "Q2",
         medRent = NA,
         actualRent = med1B,
         beds = "1 Bedroom")

#2 bedroom
Q2_2018_2B <- tract %>%
  filter(listingQtr == "2018 Q2") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2018 Q2",
         Qtr = "Q2",
         medRent = NA,
         actualRent = med2B,
         beds = "2 Bedroom")

#3 bedroom
Q2_2018_3B <- tract %>%
  filter(listingQtr == "2018 Q2") %>%
  right_join(census) %>%
  ungroup %>%
  mutate(listingQtr = "2018 Q2",
         Qtr = "Q2",
         medRent = NA,
         actualRent = med3B,
         beds = "3 Bedroom")

kc_df <- bind_rows(Q2_2017_0B, Q3_2017_0B, Q4_2017_0B, Q1_2018_0B, Q2_2018_0B,
                   Q2_2017_1B, Q3_2017_1B, Q4_2017_1B, Q1_2018_1B, Q2_2018_1B,
                   Q2_2017_2B, Q3_2017_2B, Q4_2017_2B, Q1_2018_2B, Q2_2018_2B,
                   Q2_2017_3B, Q3_2017_3B, Q4_2017_3B, Q1_2018_3B, Q2_2018_3B)
kc_df$listingQtr <- as.yearqtr(kc_df$listingQtr)
kc_df$beds <- factor(kc_df$beds)
kc_df$beds <- factor(kc_df$beds, levels = levels(kc_df$beds)[c(4, 1, 2, 3)], ordered = T)

kc_df <- kc_df %>% 
  dplyr::select(-GEOID10) %>%
  dplyr::select(GISJOIN, listingQtr, Qtr, idtract, idtract1, medRent, actualRent, beds, nHU, pOwnoccHU, medHUVal)

